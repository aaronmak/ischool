/*! ischool 17-04-2016 */
function multiplyMatrices(a,b){for(var c=[],d=0;d<a.length;d++){c[d]=[];for(var e=0;e<b[0].length;e++){for(var f=0,g=0;g<a[0].length;g++)f+=a[d][g]*b[g][e];c[d][e]=f}}return c}function toTitleCase(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}function cloneObject(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)b[c]=cloneObject(a[c]);return b}function sortTable(a,b){var c="asc"===b,d=a.find("tbody");d.find("tr").sort(function(a,b){var d=$("td:first",a).html(),e=$("td:first",b).html();return c?d-e:e-d}).appendTo(d)}function sortTableAsc(a){var b=a.find("tbody"),c=b.find("tr").clone(!0,!0),d=[];for(i=0;i<c.length;i++)for(j=0;j<c.length;j++)parseInt($("td:first",c[j]).html())===i+1&&d.push(c[j]);b.html($(d).clone(!0,!0))}function drawGraph(a){}function pop_SecondarySchools(a,b){var c=toTitleCase(String(a.properties.School_Name)),d=a.properties["2017 Expected(Express_Lower)"]?String(a.properties["2017 Expected(Express_Lower)"]):"-",e=a.properties["2017 Expected(Normal(A)_Lower)"]?String(a.properties["2017 Expected(Normal(A)_Lower)"]):"-",f=a.properties["2017 Expected(Normal(T)_Lower)"]?String(a.properties["2017 Expected(Normal(T)_Lower)"]):"-",g=$('<div class="popupGraph" style="width:100%;height:100%;"><svg/></div>')[0],h=L.popup().setContent(g),i=[["x","2014","2015","2016","2017"]];if(a.properties["2016 Sec1(Express_Lower)"]||a.properties["2014 Sec1(Express_Lower)"]||a.properties["2015 Sec1(Express_Lower)"]){var j=["Express Stream"];a.properties["2014 Sec1(Express_Lower)"]&&j.push(a.properties["2014 Sec1(Express_Lower)"]),a.properties["2015 Sec1(Express_Lower)"]&&j.push(a.properties["2015 Sec1(Express_Lower)"]),a.properties["2016 Sec1(Express_Lower)"]&&(j.push(a.properties["2016 Sec1(Express_Lower)"]),j.push(a.properties["2017 Expected(Express_Lower)"])),i.push(j)}if(a.properties["2016 Sec1(Normal(A)_Lower)"]||a.properties["2014 Sec1(Normal(A)_Lower)"]||a.properties["2015 Sec1(Normal(A)_Lower)"]){var k=["Normal(A) Stream"];a.properties["2014 Sec1(Normal(A)_Lower)"]&&k.push(a.properties["2014 Sec1(Normal(A)_Lower)"]),a.properties["2015 Sec1(Normal(A)_Lower)"]&&k.push(a.properties["2015 Sec1(Normal(A)_Lower)"]),a.properties["2016 Sec1(Normal(A)_Lower)"]&&(k.push(a.properties["2016 Sec1(Normal(A)_Lower)"]),k.push(a.properties["2017 Expected(Normal(A)_Lower)"])),i.push(k)}if(a.properties["2016 Sec1(Normal(T)_Lower)"]||a.properties["2014 Sec1(Normal(T)_Lower)"]||a.properties["2015 Sec1(Normal(T)_Lower)"]){var l=["Normal(T) Stream"];a.properties["2014 Sec1(Normal(T)_Lower)"]&&l.push(a.properties["2014 Sec1(Normal(T)_Lower)"]),a.properties["2015 Sec1(Normal(T)_Lower)"]&&l.push(a.properties["2015 Sec1(Normal(T)_Lower)"]),a.properties["2016 Sec1(Normal(T)_Lower)"]&&(l.push(a.properties["2016 Sec1(Normal(T)_Lower)"]),l.push(a.properties["2017 Expected(Normal(T)_Lower)"])),i.push(l)}c3.generate({bindto:g,size:{width:300,height:300},data:{x:"x",columns:i,regions:{"Express Stream":[{start:2016,style:"dashed"}],"Normal(A) Stream":[{start:2016,style:"dashed"}],"Normal(T) Stream":[{start:2016,style:"dashed"}]}},axis:{y:{max:300,min:100,padding:{top:20,bottom:20},label:{text:"PSLE Cut Off Score",position:"outer-middle"}},x:{padding:{right:.2},label:{text:c,position:"outer-center"},tick:{type:"timeseries",tick:{format:"%Y"}}}}});b.bindPopup(h);var m=document.createElement("tr"),n=document.createElement("td"),o=document.createElement("td"),p=document.createElement("td"),q=document.createElement("td"),r=(schoolTableBody.append(m),$("#schoolTable tbody tr:last-child"));r.append(n,o,p,q),n.innerHTML=c,o.innerHTML=d,p.innerHTML=e,q.innerHTML=f,r.click(function(){map.setView(b.getLatLng(),15),b.openPopup(),route(b)})}function schoolMarker(a){var b=L.MakiMarkers.icon({icon:"college",color:"#474747",size:"m"});return b}function highlightFeature(a){var b=a.target;info.update(b.feature)}function resetHighlight(a){a.target;info.update()}function onEachFeature(a,b){pop_SecondarySchools(a,b),b.on({mouseover:highlightFeature,mouseout:resetHighlight}),b.on("click",function(a){route(b)})}function route(a){routing?routing.spliceWaypoints(1,1,a.getLatLng()):homePoint.features[0].geometry.coordinates[1]&&(routing=L.Routing.control({position:"topleft",createMarker:function(){return null},waypoints:[L.latLng(homePoint.features[0].geometry.coordinates[1],homePoint.features[0].geometry.coordinates[0]),a.getLatLng()],draggableWaypoints:!1,addWaypoints:!1,lineOptions:{styles:[{color:"black",opacity:1,weight:8},{color:"white",opacity:.8,weight:0},{color:"#1FB5FB",opacity:1,weight:7}]}}).addTo(map))}function homeMarker(a){var b=L.MakiMarkers.icon({icon:"building",color:"#ffbe95",size:"l"});return b}function getCoord(a){add_hmarker&&map.removeLayer(add_hmarker);var b="http://www.onemap.sg/API/services.svc/getToken?accessKEY=j6/Rfby70oVeYjQxxA2ZsgGpk+VKBUyP6mhmDVQmu+NQVW0ylJG6K0/MgUI8B49FH0A0Fs7Nb5Nb/2PcjolCcwNGytg/J27TSXxrkWgeAqYM0qi2ManejNlLmtuP6c/g|mv73ZvjFcSo=";"localhost"==document.location.hostname&&(b="http://www.onemap.sg/API/services.svc/getToken?accessKEY=xkg8VRu6Ol+gMH+SUamkRIEB7fKzhwMvfMo/2U8UJcFhdvR4yN1GutmUIA3A6r3LDhot215OVVkZvNRzjl28TNUZgYFSswOi");var c="";console.log("getTokenURL: "+b),$.getJSON(b).done(function(b){c=b.GetToken[0].NewToken;var d="http://www.onemap.sg/APIV2/services.svc/basicSearchV2?token="+c+"&searchVal="+a+"&otptFlds=SEARCHVAL,CATEGORY&returnGeom=0&rset=1&projSys=WGS84";$.getJSON(d).done(function(a){if(2===a.SearchResults.length){var b=parseFloat(a.SearchResults[1].X),c=parseFloat(a.SearchResults[1].Y);homeCoord=[b,c],homePoint.features[0].geometry.coordinates=homeCoord,add_hmarker=L.geoJson(homePoint,{pointToLayer:function(a,b){return L.marker(b,{icon:homeMarker(a)})}}).addTo(map),$("#postalCodeResult").html("Postal Code Found")}else $("#postalCodeResult").html("Postal Code Not Found")}).fail(function(a){$("#postalCodeResult").html("<span>Postal Code Error</span>")})})}function calcWeight(){var a=[],b=[],c=[],d=0;for(a.push(parseFloat(slider1.noUiSlider.get()),parseFloat(slider2.noUiSlider.get()),parseFloat(slider3.noUiSlider.get()),parseFloat(slider4.noUiSlider.get()),parseFloat(slider5.noUiSlider.get()),parseFloat(slider6.noUiSlider.get()),parseFloat(slider7.noUiSlider.get()),parseFloat(slider8.noUiSlider.get()),parseFloat(slider9.noUiSlider.get()),parseFloat(slider10.noUiSlider.get())),i=0;i<a.length;i++)0===a[i]?a[i]=1:a[i]>0?a[i]++:(a[i]--,a[i]=Math.pow(-1*a[i],-1));for(i=0;i<5;i++){var e=[];for(j=0;j<5;j++)if(i===j)e.push(1);else if(j>i){var f=a.shift();e.push(f)}else e.push("");b.push(e)}for(i=0;i<b.length;i++)for(j=0;j<b.length;j++)""===b[i][j]&&(b[i][j]=Math.pow(b[j][i],-1));for(b=multiplyMatrices(b,b),i=0;i<b.length;i++){var g=0;for(j=0;j<b.length;j++)g+=b[j][i];c.push(g),d+=g}for(j=0;j<c.length;j++)c[j]=c[j]/d;return c}function calcDist(){var a=homePoint.features[0],b=[],c="kilometers";for(i=0;i<schoolPoints.length;i++){var d=turf.distance(a,schoolPoints[i],c);b[i]=d}return b}function inverseArr(a){var b=[];for(i=0;i<a.length;i++)b.push(1/a[i]);return b}function getValues(){var a={},b={},c={};for(i=0;i<schoolPoints.length;i++)a[i]=schoolPoints[i].properties.AE,b[i]=schoolPoints[i].properties.SportsPro,c[i]=schoolPoints[i].properties.ArtProg;return[a,b,c]}function calcValue(a){var b=[],c=[],d=0;for(i=0;i<170;i++)d+=a[i],b.push(a[i]);for(i=0;i<b.length;i++)temp=b[i]/d,c.push(temp);return c}function calcSG(){var a=document.getElementById("prefGen").value,b=[],c=[],d=0;for(i=0;i<170;i++)schoolPoints[i].properties.Gender==a?(b.push(1),d+=1):(b.push(0),d+=0);for(i=0;i<b.length;i++)temp=b[i]/d,c.push(temp);return c}function calcAHP(a,b){var c=[];for(i=0;i<170;i++){var d=0;for(j=0;j<5;j++)d+=a[j][i]*b[j];c[i]=d}return c}function calcSuccess(){var a=parseInt($("#psleScore").val());a>300&&$("#psleScore").val(function(){return 300});var b=[],c=[];if("express"===streamInput.val())for(i=0;i<schoolPoints.length;i++)b.push(parseInt($("#schoolTable tr:nth-child("+(i+1)+") td:nth-child(3)").html()));else if("normalAcad"===streamInput.val())for(i=0;i<schoolPoints.length;i++)b.push(parseInt($("#schoolTable tr:nth-child("+(i+1)+") td:nth-child(4)").html()));else for(i=0;i<schoolPoints.length;i++)b.push(parseInt($("#schoolTable tr:nth-child("+(i+1)+") td:nth-child(5)").html()));for(i=0;i<b.length;i++)if(isNaN(b[i]))c.push("-");else if(a<b[i])c.push("No");else{if(!(a>=b[i]))return;c.push("Yes")}for($("#schoolTable tbody tr td:nth-child(7)").html()&&$("#schoolTable tbody tr td:nth-child(7)").remove(),i=0;i<c.length;i++)$("#schoolTable tbody tr:nth-child("+(i+1)+")").append("<td>"+c[i]+"</td>");boldTableResult()}function boldTableResult(){$('table tr td:nth-child(7):contains("Yes")').parent().css("font-weight","700"),$('table tr td:nth-child(7):contains("No")').parent().css("font-weight","400"),$('table tr td:nth-child(7):contains("-")').parent().css("font-weight","400")}Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c};var map=L.map("map",{zoomControl:!1,maxZoom:17,minZoom:11}).fitBounds([[1.470774832084756,104.08848306516336],[1.158698700635265,103.60543572198932]]),feature_group=new L.featureGroup([]),bounds_group=new L.featureGroup([]),basemap=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:' &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',maxZoom:17}).addTo(map);L.control.zoom({position:"topleft"}).addTo(map),L.control.scale({options:{position:"bottomright",maxWidth:100,metric:!0,imperial:!1,updateWhenIdle:!1}}).addTo(map);var sidebar=L.control.sidebar("sidebar-control",{position:"right"});map.addControl(sidebar);var info=L.control({position:"bottomleft"});info.onAdd=function(a){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},info.update=function(a){var b=["&#9734","&#9734","&#9733"];this._div.innerHTML="<h4>School Information</h4>"+(a?"<b>"+toTitleCase(a.properties.School_Name)+"</b><br />School Gender : "+a.properties.Gender+"<br />Art Programs : "+b[a.properties.ArtProg]+"<br />Sports Programs : "+b[a.properties.SportsPro]:"Hover a school"),drawGraph(a)},info.addTo(map);var defaultOptions={start:0,step:1,behaviour:"tap",range:{min:-3,max:3},pips:{mode:"count",values:7,density:7}},slider1=document.getElementById("slider0-1"),slider2=document.getElementById("slider0-2"),slider3=document.getElementById("slider0-3"),slider4=document.getElementById("slider0-4"),slider5=document.getElementById("slider1-2"),slider6=document.getElementById("slider1-3"),slider7=document.getElementById("slider1-4"),slider8=document.getElementById("slider2-3"),slider9=document.getElementById("slider2-4"),slider10=document.getElementById("slider3-4");noUiSlider.create(slider1,defaultOptions),noUiSlider.create(slider2,defaultOptions),noUiSlider.create(slider3,defaultOptions),noUiSlider.create(slider4,defaultOptions),noUiSlider.create(slider5,defaultOptions),noUiSlider.create(slider6,defaultOptions),noUiSlider.create(slider7,defaultOptions),noUiSlider.create(slider8,defaultOptions),noUiSlider.create(slider9,defaultOptions),noUiSlider.create(slider10,defaultOptions);var schoolTableBody=$("#schoolTable tbody"),schoolPoints=[],highlightmarker=L.MakiMarkers.icon({icon:"college",color:"#de2d26",size:"m"}),routing,json_SecondarySchools=new L.geoJson(secondarySchools,{onEachFeature:onEachFeature,pointToLayer:function(a,b){return schoolPoints.push(a),L.marker(b,{icon:schoolMarker(a)})}}).addTo(map),homePoint={type:"FeatureCollection",crs:{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}},features:[{type:"Feature",properties:{name:"Home"},geometry:{type:"Point",coordinates:[]}}]},homePostalCode=0,homeCoord,add_hmarker,originalTable=$("#schoolTable").clone(!0,!0);$("#inputPostalCode").change(function(){getCoord($("#inputPostalCode").val())}),$("#buttonAHP").click(function(){getCoord($("#inputPostalCode").val()),relaRanking=calcWeight();var a=[],b=[],c=calcDist(add_hmarker),d=inverseArr(c);valueList=getValues(),AcademicList=valueList[0],SportsProgramList=valueList[1],ArtsProgramList=valueList[2],AcadeExcelRanking=calcValue(AcademicList),a.push(AcadeExcelRanking),SporProgRanking=calcValue(SportsProgramList),a.push(SporProgRanking),ArtProgRanking=calcValue(ArtsProgramList),a.push(ArtProgRanking),DistRanking=calcValue(d),a.push(DistRanking),SGRanking=calcSG(),a.push(SGRanking),schoolScore=calcAHP(a,relaRanking);var e=cloneObject(schoolScore);for(e.sort(function(a,b){return b-a}),i=0;i<schoolScore.length;i++)for(j=0;j<e.length;j++)schoolScore[i]===e[j]&&b.push(j+1);for($("#schoolTable").html(originalTable.clone(!0,!0)),i=0;i<b.length;i++)$("#schoolTable tbody tr:nth-child("+(i+1)+")").prepend("<td>"+b[i]+"</td>"),$("#schoolTable tbody tr:nth-child("+(i+1)+")").append("<td>"+Math.round(1e3*c[i])+"</td>");sortTableAsc($("#schoolTable")),$(".sidebar-tabs ul li").removeClass("active"),$(".sidebar-content div").removeClass("active"),$(".sidebar-tabs ul li:first-child").removeClass("disabled"),$(".sidebar-tabs ul li:first-child").addClass("active"),$(".sidebar-content div:first-child").addClass("active"),$("#schoolTable tr td:nth-child(3)").show(),$(".sidebar-tabs ul li:first-child").show(),$("#schoolTable tbody tr").append("<td>?</td>"),calcSuccess(),boldTableResult()});var streamInput=$("#streamInput");$("#schoolTable tr td:nth-child(3)").show(),streamInput.change(function(){calcSuccess(),"express"===streamInput.val()?($("#schoolTable tr td:nth-child(3)").show(),$("#schoolTable tr td:nth-child(4)").hide(),$("#schoolTable tr td:nth-child(5)").hide()):"normalAcad"===streamInput.val()?($("#schoolTable tr td:nth-child(4)").show(),$("#schoolTable tr td:nth-child(3)").hide(),$("#schoolTable tr td:nth-child(5)").hide()):($("#schoolTable tr td:nth-child(5)").show(),$("#schoolTable tr td:nth-child(3)").hide(),$("#schoolTable tr td:nth-child(4)").hide())}),$("#psleScore").change(function(){calcSuccess()});